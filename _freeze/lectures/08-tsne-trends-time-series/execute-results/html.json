{
  "hash": "1bb57af47c4cae637293dc75c662b126",
  "result": {
    "markdown": "---\ntitle: \"t-SNE + visualizing trends and time series data\"\nauthor: \"Prof Ron Yurko\"\nfooter:  \"[mads-36613-fall24](https://ryurko.github.io/mads-36613-fall24/)\"\ndate: 2024-09-23\nengine: knitr\nformat:\n  revealjs:\n    theme: theme.scss\n    chalkboard: true\n    pdf-separate-fragments: true\n    slide-number: c/t\n    smaller: true\n    code-line-numbers: true\n    linestretch: 1.25\n    html-math-method:\n      method: mathjax\n      url: \"https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js\"\n---\n\n\n\n\n## Reminders, previously, and today...\n\n+ **HW4 is due Wednesday Sept 25th** \n\n+ **You need to email me a draft of your EDA report!** (1 per group)\n\n. . .\n\n+ Walked through PCA for dimension reduction\n\n+ Discussed choosing the number of PCs with scree plots\n\n+ Created biplots for interpreting variable contributions to PCs\n\n. . .\n\n**TODAY:**\n\n+ Introduce non-linear dimension reduction with t-SNE plots\n\n+ Discuss visualizing trends\n\n+ Walk through the basics of time series data\n\n---\n\n## Consider the following spiral structure...\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-2-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n\n---\n\n## PCA simply rotates the data...\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-3-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n\n---\n\n## Nonlinear dimension reduction with t-SNE\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-4-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n\n---\n\n## [t-distributed stochastic neighbor embedding](https://en.wikipedia.org/wiki/T-distributed_stochastic_neighbor_embedding)\n\n- Construct conditional probability for similarity between observations in original space, i.e., probability $x_i$ will pick $x_j$ as its neighbor \n\n$$p_{j \\mid i}=\\frac{\\exp \\left(-\\left\\|x_i-x_j\\right\\|^2 / 2 \\sigma_i^2\\right)}{\\sum_{k \\neq i} \\exp \\left(-\\left\\|x_i-x_k\\right\\|^2 / 2 \\sigma_i^2\\right)},\\quad p_{i j}=\\frac{\\left(p_{j \\mid i}+p_{i \\mid j}\\right)}{2 n}$$\n\n- $\\sigma_i$ is the variance of Gaussian centered at $x_i$ controlled by __perplexity__:  $\\log (\\text { perplexity })=-\\sum_j p_{j \\mid i} \\log _2 p_{j \\mid i}$\n\n---\n\n## [t-distributed stochastic neighbor embedding](https://en.wikipedia.org/wiki/T-distributed_stochastic_neighbor_embedding)\n\n- Find points $y_i$ in lower dimensional space with symmetrized student t-distribution\n\n$$q_{j \\mid i}=\\frac{\\left(1+\\left\\|y_i-y_j\\right\\|^2\\right)^{-1}}{\\sum_{k \\neq i}\\left(1+\\left\\|y_i-y_k\\right\\|^2\\right)^{-1}}, \\quad q_{i j}=\\frac{q_{i \\mid j}+q_{j \\mid i}}{2 n}$$\n\n- Match conditional probabilities by minimize sum of KL divergences $C=\\sum_{i j} p_{i j} \\log \\left(\\frac{p_{i j}}{q_{i j}}\\right)$\n\n---\n\n## Starbucks t-SNE plot with [`Rtsne`](https://github.com/jkrijthe/Rtsne) \n\n\n::: {.cell layout-align=\"center\" output-location='slide'}\n\n```{.r .cell-code}\nset.seed(2013)\ntsne_fit <- starbucks |>\n  dplyr::select(serv_size_m_l:caffeine_mg) |>\n  scale() |>\n  Rtsne(check_duplicates = FALSE) \n\nstarbucks |>\n  mutate(tsne1 = tsne_fit$Y[,1],\n         tsne2 = tsne_fit$Y[,2]) |>\n  ggplot(aes(x = tsne1, y = tsne2, \n             color = size)) +\n  geom_point(alpha = 0.5) + \n  labs(x = \"t-SNE 1\", y = \"t-SNE 2\")\n```\n\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-5-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n\n\n---\n\n## Starbucks t-SNE plot - involves randomness!\n\n\n\n::: {.cell layout-align=\"center\" output-location='slide'}\n\n```{.r .cell-code}\nset.seed(2014) \ntsne_fit <- starbucks |>\n  dplyr::select(serv_size_m_l:caffeine_mg) |>\n  scale() |>\n  Rtsne(check_duplicates = FALSE) \n\nstarbucks |>\n  mutate(tsne1 = tsne_fit$Y[,1],\n         tsne2 = tsne_fit$Y[,2]) |>\n  ggplot(aes(x = tsne1, y = tsne2, \n             color = size)) +\n  geom_point(alpha = 0.5) +\n  labs(x = \"t-SNE 1\", y = \"t-SNE 2\")\n```\n\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-6-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n\n\n---\n\n## Starbucks t-SNE plot - watch the perplexity!\n\n\n::: {.cell layout-align=\"center\" output-location='slide'}\n\n```{.r .cell-code}\nset.seed(2013) \ntsne_fit <- starbucks |>\n  dplyr::select(serv_size_m_l:caffeine_mg) |>\n  scale() |>\n  Rtsne(perplexity = 100, \n        check_duplicates = FALSE)\n\nstarbucks |>\n  mutate(tsne1 = tsne_fit$Y[,1],\n         tsne2 = tsne_fit$Y[,2]) |>\n  ggplot(aes(x = tsne1, y = tsne2, \n             color = size)) +\n  geom_point(alpha = 0.5) +\n  labs(x = \"t-SNE 1\", y = \"t-SNE 2\")\n```\n\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-7-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n\n---\n\n## Back to the spirals: results depend on perplexity!\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-8-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n\n---\n\n## Criticisms of t-SNE plots\n\n\n- __Poor scalability__: does not scale well for large data, can practically\nonly embed into 2 or 3 dimensions\n\n- __Meaningless global structure__: distance between clusters might not\nhave clear interpretation and cluster size doesnâ€™t have any meaning to\nit\n\n- __Poor performance with very high dimensional data__: need PCA as\npre-dimension reduction step\n\n- [__Sometime random noise can lead to false positive structure in the\nt-SNE projection__](https://distill.pub/2016/misread-tsne/)\n\n- __Can NOT interpret like PCA!__\n\n---\n\n## Longitudinal data and time series structure\n\n- Consider a _single observation_ measured across time\n\n| Variable   | $T_1$   | $T_2$   | $\\dots$  | $T_J$ |\n| ---------- | -------- | -------- | -------- | -------- |\n| $X_1$ | $x_{11}$ | $x_{12}$ | $\\dots$  | $x_{1J}$ |\n| $X_2$ | $x_{21}$ | $x_{22}$ | $\\dots$  | $x_{2J}$ |\n| $\\vdots$    | $\\vdots$  | $\\vdots$  | $\\dots$  | $\\vdots$  |\n| $X_P$ | $x_{P1}$ | $x_{P2}$ | $\\dots$  | $x_{PJ}$ |\n\n\n- With $N$ observations we have $N$ of these matrices\n\n- Time may consist of regularly spaced intervals\n\n  - For example, $T_1 = t$, $T_2 = t + h$, $T_3 = t + 2h$, etc.\n  \n- Irregularly spaced intervals, then work with the raw $T_1,T_2,...$\n\n\n---\n\n## Example: Statistics PhDs by year\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nstat_phd_year_summary |>\n  ggplot(aes(x = year, y = n_phds)) +\n  geom_point() +\n  theme_light() +\n  labs(x = \"Year\", y = \"Number of PhDs\", title = \"Number of Statistics-related PhDs awarded over time\")\n```\n\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-9-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n\n## Example: Statistics PhDs by year\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-line-numbers=\"4-5\"}\nstat_phd_year_summary |>\n  ggplot(aes(x = year, y = n_phds)) +\n  geom_point() +\n  scale_x_continuous(breaks = unique(stat_phd_year_summary$year), \n                     labels = unique(stat_phd_year_summary$year)) + \n  theme_light() +\n  labs(x = \"Year\", y = \"Number of PhDs\", title = \"Number of Statistics-related PhDs awarded over time\")\n```\n\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-10-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n---\n\n## Add lines to emphasize order\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-line-numbers=\"4\"}\nstat_phd_year_summary |>\n  ggplot(aes(x = year, y = n_phds)) +\n  geom_point() +\n  geom_line() +\n  scale_x_continuous(breaks = unique(stat_phd_year_summary$year),\n                     labels = unique(stat_phd_year_summary$year)) +\n  theme_light() +\n  labs(x = \"Year\", y = \"Number of PhDs\",\n       title = \"Number of Statistics-related PhDs awarded over time\")\n```\n\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-11-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n\n---\n\n## Drop points to emphasize trends\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nstat_phd_year_summary |>\n  ggplot(aes(x = year, y = n_phds)) +\n  geom_line() +\n  scale_x_continuous(breaks = unique(stat_phd_year_summary$year),\n                     labels = unique(stat_phd_year_summary$year)) +\n  theme_light() +\n  labs(x = \"Year\", y = \"Number of PhDs\",\n       title = \"Number of Statistics-related PhDs awarded over time\")\n```\n\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-12-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n---\n\n## Can fill the area under the line\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-line-numbers=\"3\"}\nstat_phd_year_summary |>\n  ggplot(aes(x = year, y = n_phds)) +\n  geom_area(fill = \"darkblue\", alpha = 0.5) +\n  geom_line() +\n  scale_x_continuous(breaks = unique(stat_phd_year_summary$year),\n                     labels = unique(stat_phd_year_summary$year)) +\n  theme_light() +\n  labs(x = \"Year\", y = \"Number of PhDs\",\n       title = \"Number of Statistics-related PhDs awarded over time\")\n```\n\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-13-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n\n---\n\n## Several time series? Do NOT only use points\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-line-numbers=\"2\"}\nstats_phds |>\n  ggplot(aes(x = year, y = n_phds, color = field)) +\n  geom_point() +\n  scale_x_continuous(breaks = unique(stat_phd_year_summary$year),\n                     labels = unique(stat_phd_year_summary$year)) +\n  theme_light() +\n  theme(legend.position = \"bottom\", legend.text = element_text(size = 7)) +\n  labs(x = \"Year\", y = \"Number of PhDs\",\n       title = \"Number of Statistics-related PhDs awarded over time\",\n       color = \"Field\")\n```\n\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-14-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n\n---\n\n## Several time series? Use lines!\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code  code-line-numbers=\"2\"}\nstats_phds |>\n  ggplot(aes(x = year, y = n_phds, color = field)) +\n  geom_line() +\n  scale_x_continuous(breaks = unique(stat_phd_year_summary$year),\n                     labels = unique(stat_phd_year_summary$year)) +\n  theme_light() +\n  theme(legend.position = \"bottom\") +\n  labs(x = \"Year\", y = \"Number of PhDs\", color = \"Field\",\n       title = \"Number of Statistics-related PhDs awarded over time\")\n```\n\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-15-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n---\n\n## Using [`ggrepel`](https://ggrepel.slowkow.com/articles/examples.html) to directly label lines\n\n\n::: {.cell layout-align=\"center\" output-location='slide'}\n\n```{.r .cell-code}\nstats_phds_2017 <- stats_phds |> filter(year == 2017)\n\nlibrary(ggrepel)\nstats_phds |>\n  ggplot(aes(x = year, y = n_phds, color = field)) +\n  geom_line() +\n  # Add the labels:\n  geom_text_repel(data = stats_phds_2017, aes(label = field),\n                  size = 3, \n                  # Drop the segment connection:\n                  segment.color = NA, \n                  # Move labels up or down based on overlap\n                  direction = \"y\",\n                  # Try to align the labels horizontally on the left hand side\n                  hjust = \"left\") +\n  scale_x_continuous(breaks = unique(stat_phd_year_summary$year),\n                     labels = unique(stat_phd_year_summary$year),\n                     # Update the limits so that there is some padding on the\n                     # x-axis but don't label the new maximum\n                     limits = c(min(stat_phd_year_summary$year),\n                                max(stat_phd_year_summary$year) + 3)) +\n  theme_light() +\n  theme(legend.position = \"none\") +\n  labs(x = \"Year\", y = \"Number of PhDs\", color = \"Field\",\n       title = \"Number of Statistics-related PhDs awarded over time\")\n```\n\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-16-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n---\n\n## Using [`gghighlight`](https://yutannihilation.github.io/gghighlight/articles/gghighlight.html) instead\n\n\n::: {.cell layout-align=\"center\" output-location='slide'}\n\n```{.r .cell-code  code-line-numbers=\"1,5\"}\nlibrary(gghighlight)\nstats_phds |>\n  ggplot(aes(x = year, y = n_phds, color = field)) +\n  geom_line() +\n  gghighlight()  +\n  scale_x_continuous(breaks = unique(stat_phd_year_summary$year),\n                     labels = unique(stat_phd_year_summary$year)) +\n  theme_light() +\n  theme(legend.position = \"none\") +\n  labs(x = \"Year\", y = \"Number of PhDs\", color = \"Field\",\n       title = \"Number of Statistics-related PhDs awarded over time\")\n```\n\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-17-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n---\n\n## Using [`gghighlight`](https://yutannihilation.github.io/gghighlight/articles/gghighlight.html) instead\n\n\n\n::: {.cell layout-align=\"center\" output-location='slide'}\n\n```{.r .cell-code  code-line-numbers=\"1,5\"}\nlibrary(gghighlight)\nstats_phds |>\n  ggplot(aes(x = year, y = n_phds, color = field)) +\n  geom_line() +\n  gghighlight(line_label_type = \"sec_axis\")  +\n  scale_x_continuous(breaks = unique(stat_phd_year_summary$year),\n                     labels = unique(stat_phd_year_summary$year)) +\n  theme_light() +\n  theme(legend.position = \"none\") +\n  labs(x = \"Year\", y = \"Number of PhDs\", color = \"Field\",\n       title = \"Number of Statistics-related PhDs awarded over time\")\n```\n\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-18-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n\n---\n\n## How do we plot many lines? NOT LIKE THIS!\n\n\n::: {.cell layout-align=\"center\" output-location='slide'}\n\n```{.r .cell-code  code-line-numbers=\"1\"}\nphd_field |>\n  ggplot(aes(x = year, y = n_phds, color = field)) +\n  geom_line() +\n  scale_x_continuous(breaks = unique(stat_phd_year_summary$year),\n                     labels = unique(stat_phd_year_summary$year)) +\n  theme_light() +\n  theme(legend.position = \"none\") +\n  labs(x = \"Year\", y = \"Number of PhDs\", color = \"Field\",\n       title = \"Number of Statistics-related PhDs awarded over time\")\n```\n\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-19-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n---\n\n## Instead we highlight specific lines\n\n\n::: {.cell layout-align=\"center\" output-location='slide'}\n\n```{.r .cell-code}\nphd_field |>\n  filter(!(field %in% c(\"Biometrics and biostatistics\", \"Statistics (mathematics)\"))) |>\n  ggplot() +\n  # Add the background lines - need to specify the group to be the field\n  geom_line(aes(x = year, y = n_phds, group = field),\n            color = \"gray\", size = .5, alpha = .5) +\n  # Now add the layer with the lines of interest:\n  geom_line(data = filter(phd_field,\n                          # Note this is just the opposite of the above since ! is removed\n                          field %in% c(\"Biometrics and biostatistics\", \n                                       \"Statistics (mathematics)\")),\n            aes(x = year, y = n_phds, color = field),\n            # Make the size larger\n            size = .75, alpha = 1) +\n  scale_x_continuous(breaks = unique(stat_phd_year_summary$year),\n                     labels = unique(stat_phd_year_summary$year)) +\n  theme_light() +\n  theme(legend.position = \"bottom\", \n        # Drop the panel lines making the gray difficult to see\n        panel.grid = element_blank()) +\n  labs(x = \"Year\", y = \"Number of PhDs\", color = \"Field\",\n       title = \"Number of Statistics-related PhDs awarded over time\")\n```\n\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-20-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n\n---\n\n## Or you can use [`gghighlight`](https://yutannihilation.github.io/gghighlight/articles/gghighlight.html) instead\n\n\n\n::: {.cell layout-align=\"center\" output-location='slide'}\n\n```{.r .cell-code  code-line-numbers=\"4-5\"}\nphd_field |>\n  ggplot(aes(x = year, y = n_phds, color = field)) +\n  geom_line() +\n  gghighlight(field %in% c(\"Biometrics and biostatistics\", \"Statistics (mathematics)\"),\n              line_label_type = \"sec_axis\") +\n  scale_x_continuous(breaks = unique(stat_phd_year_summary$year),\n                     labels = unique(stat_phd_year_summary$year)) +\n  theme_light() +\n  theme(legend.position = \"none\") +\n  labs(x = \"Year\", y = \"Number of PhDs\", color = \"Field\",\n       title = \"Number of Statistics-related PhDs awarded over time\")\n```\n\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-21-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n---\n\n## What about Nightingale's rose diagram?\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](https://daily.jstor.org/wp-content/uploads/2020/08/florence_nightingagle_data_visualization_visionary_1050x700.jpg){fig-align='center' width=75%}\n:::\n:::\n\n\n---\n\n## What about Nightingale's rose diagram?\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-23-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n\n---\n\n## What about displaying lines instead?\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-24-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n\n---\n\n## Things of interest for time series data\n\nTime series can be characterized by three features:\n\n1. __Trends__: Does the variable increase or decrease over time, on average?\n\n2. __Seasonality__: Are there changes in the variable that regularly happen (e.g., every winter, every hour, etc.)? Sometimes called periodicity.\n\n3. __Noise__: Variation in the variable beyond average trends and seasonality.\n\n**Moving averages are a starting point for visualizing how a trend changes over time**\n\n---\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](https://www.ft.com/__origami/service/image/v2/images/raw/https%3A%2F%2Fd6c748xw2pzm8.cloudfront.net%2Fprod%2Fc7ce2780-2f14-11eb-8e8a-cdb0723f9e68-standard.png?dpr=1&fit=scale-down&quality=highest&source=next&width=700){fig-align='center' width=80%}\n:::\n:::\n\n\n\n---\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](https://icharts.coinlore.com/img/simple-moving-averages-ftx-token.jpg?time=1680119681){fig-align='center'}\n:::\n:::\n\n\n\n---\n\n## Be responsible with your axes!\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](https://cdn.sisense.com/wp-content/uploads/National-Review-Climate-Change-770x689.png){fig-align='center' width=50%}\n:::\n:::\n\n\n\n---\n\n## Be responsible with your axes!\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](http://www.washingtonpost.com/blogs/the-fix/files/2015/12/NRO_Temp_1.jpg){fig-align='center' width=50%}\n:::\n:::\n\n\n\n---\n\n## Moving Average Plots\n\nThe _Financial Times_ COVID-19 plots displayed a __moving average__ (sometimes called a __rolling average__)\n\n**Intuition**\n\n1. Divide your data into small subsets (\"windows\")\n\n2. Compute the average within each window\n\n3. Connect the averages together to make a trend line\n\n. . .\n\nSometimes called a __simple moving average__\n\nThis is exactly what we did with LOESS... we called this a _sliding window_, but it's the same thing\n\n---\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-29-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n\n---\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-30-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n\n---\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-31-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n\n---\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-32-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n\n---\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-33-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n\n---\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-34-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n\n---\n\n## How are moving averages computed?\n\n**Intuition**\n\n1. Divide your data into small subsets (_windows_)\n\n2. Compute the average within each window\n\n3. Connect the averages together to make a trend line\n\n. . .\n\nMathematically, a moving average can be written as the following:\n\n$$\\mu_k = \\frac{\\sum_{t=k - h + 1}^k X_t}{h}$$\n\n+ Large $h$: Smooth line; captures global trends\n\n+ Small $h$: Jagged/volatile line; captures local trends\n\n\n---\n\n## Working with Time Series\n\n`co2`: Mauna Loa Atmospheric CO2 Concentration dataset (monthly $\\text{CO}^2$ concentration 1959 to 1997)\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nco2_tbl |>\n  ggplot(aes(x = obs_i, y = co2_val)) + \n  geom_line() + \n  labs(x = \"Time index\", y = \"CO2 (ppm)\")\n```\n\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-35-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n---\n\n## Formatting Dates\n\nCan use `as.Date()` to create time indexes.\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-36-1.png){fig-align='center' width=960}\n:::\n:::\n\n\nDefault format is Year/Month/Day. For something else, need to specify `format` in `as.Date()` (e.g., `format = \"%m/%d/%Y\"`)\n\n---\n\n## Use `scale_x_date()` to create interpretable axis labels \n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-37-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n\n---\n\n### Use [`ggseas`](https://cran.r-project.org/web/packages/ggseas/vignettes/ggseas.html) package to plot moving averages\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(ggseas)\nco2_tbl |> \n  ggplot(aes(x = obs_date, y = co2_val)) + geom_line(color = \"red\") + \n  stat_rollapplyr(width = 12, align = \"right\") +\n  labs(x = \"Year\", y = \"CO2 (ppm)\", title = \"Width = 12\")\n```\n\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-38-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n\n---\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-39-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n\n\n---\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-40-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n\n---\n\n## Other Moving Averages\n\n\nTwo other common averages: Cumulative moving averages and weighted moving averages.\n\n+ __Cumulative moving average__: The average at time $k$ is the average of all points at and before $k$. Mathematically:\n\n$$\\mu_k^{(CMA)} = \\frac{\\sum_{t=1}^k X_t}{k}$$\n\n. . .\n\n+ __Weighted moving average__: Same as simple moving average, but different measurements get different weights for the average.\n\n$$\\mu_k^{(WMA)} = \\frac{\\sum_{t=k - h + 1}^k X_t \\cdot w_t}{ \\sum_{t=k - h + 1}^k w_t}$$\n\n\n---\n\n## Working with lags\n\nTime series data is fundamentally different from other data problems we've worked with because measurements are  __not independent__\n\nObvious example: The temperature today is correlated with temperature yesterday. (_Maybe not in Pittsburgh?_)\n\n. . .\n\nImportant term: __lags__. Used to determine if one time point influences future time points.\n\nLag 1: Comparing time series at time $t$ with time series at time $t - 1$. \n\nLag 2: Comparing time series at time $t$ with time series at time $t - 2$.\n\nAnd so on...\n\n. . .\n\nLet's say we have time measurements $(X_1, X_2, X_3, X_4, X_5)$. \n\nThe $\\ell = 1$ lag is $(X_2, X_3, X_4, X_5)$ vs $(X_1, X_2, X_3, X_4)$. \n\n. . .\n\nThe $\\ell = 2$ lag is $(X_3, X_4, X_5)$ vs $(X_1, X_2, X_3)$.\n\nConsider: Are previous outcomes (lags) predictive of future outcomes?\n\n---\n\n## Autocorrelation\n\n__Autocorrelation__: Correlation between a time series and a lagged version of itself.\n\nDefine $r_{\\ell}$ as the correlation between a time series and Lag $\\ell$ of that time series.\n\n. . .\n\nLag 1: $r_1$ is correlation between $(X_2, X_3, X_4, X_5)$ and $(X_1,X_2,X_3,X_4)$ \n\nLag 2: $r_2$ is correlation between $(X_3, X_4, X_5)$ and $(X_1,X_2,X_3)$\n\nAnd so on...\n\n. . .\n\nCommon diagnostic: Plot $\\ell$ on x-axis, $r_{\\ell}$ on y-axis.\n\nTells us if correlations are \"significantly large\" or \"significantly small\" for certain lags\n\nTo make an autocorrelation plot, we use the `acf()` function; the `ggplot` version uses `autoplot()`\n\n---\n\n## Autocorrelation plots\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(ggfortify)\nauto_corr <- acf(co2_tbl$co2_val, plot = FALSE)\nautoplot(auto_corr)\n```\n\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-41-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n\n---\n\n### Autocorrelation Plots and Seasonality\n\nWith strong global trends, autocorrelations will be very positive.\n\n. . .\n\n**Helpful: Visualize autocorrelations after removing the global trend (compute moving average with `rollapply()`)**\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-42-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n\n---\n\n## Autocorrelation Plots and Seasonality\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-43-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n---\n\n### Seasonality Decomposition\n\nRemember that there are three main components to a time series:\n\n1. Average trends\n\n2. Seasonality\n\n3. Noise\n\n. . .\n\nUse `ggsdc()` (from [`ggseas`](https://cran.r-project.org/web/packages/ggseas/vignettes/ggseas.html)) to decompose a time series into these three components\n\n+ Plots the observed time series.\n\n+ Plots a loess curve as the global trend.\n\n+ Plots another loess curve on (observed - trend) as the seasonality.\n\n+ Plots the noise (observed - trend - seasonality).\n\n---\n\n### Seasonality Decomposition\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nco2_tbl |>\n  ggsdc(aes(obs_date, co2_val), frequency = 12, method = \"stl\", s.window = 12) +\n  geom_line() + labs(x = \"Year\", y = \"CO2 (ppm)\")\n```\n\n::: {.cell-output-display}\n![](08-tsne-trends-time-series_files/figure-revealjs/unnamed-chunk-44-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n\n---\n\n## Recap and next steps\n\n+ Discussed non-linear dimension reduction with t-SNE plots\n\n+ Discussed various aspects of visualizing trends\n\n+ Walked through basics of time series data, such as moving averages, autocorrelation, seasonality\n\n. . .\n\n\n+ **HW4 is due Wednesday Sept 25th**\n\n+ **You need to email me a draft of your EDA report!** (1 per group)\n\n. . .\n\n+ **Next time**: Visualizing spatial data\n\n+ Recommended reading: [How to Use t-SNE Effectively](https://distill.pub/2016/misread-tsne/), [Understanding UMAP](https://pair-code.github.io/understanding-umap/), [CW CH 13 Visualizing time series and other functions of an independent variable](https://clauswilke.com/dataviz/time-series.html), [CW CH 14 Visualizing trends](https://clauswilke.com/dataviz/visualizing-trends.html)\n\n\n\n",
    "supporting": [
      "08-tsne-trends-time-series_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    // dispatch for htmlwidgets\n    function fireSlideEnter() {\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n    }\n\n    function fireSlideChanged(previousSlide, currentSlide) {\n      fireSlideEnter();\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}